<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:bioc="http://bpmn.io/schema/bpmn/biocolor/1.0" xmlns:color="http://www.omg.org/spec/BPMN/non-normative/color/1.0" xmlns:modeler="http://camunda.org/schema/modeler/1.0" id="Definitions_19byja1" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="5.15.0" modeler:executionPlatform="Camunda Platform" modeler:executionPlatformVersion="7.19.0">
  <bpmn:collaboration id="Collaboration_0ietaej">
    <bpmn:participant id="Participant_191iq4g" name="Платеж" processRef="paymentProcess" />
  </bpmn:collaboration>
  <bpmn:process id="paymentProcess" name="Платёжный процесс" isExecutable="true" camunda:historyTimeToLive="P1D">
    <bpmn:startEvent id="StartEvent_1" name="Получен платёж">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="${processLogger}" event="start" />
      </bpmn:extensionElements>
      <bpmn:outgoing>SequenceFlow_1</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:inclusiveGateway id="InclusiveGateway_1" name="Обработка платежа">
      <bpmn:incoming>SequenceFlow_1</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_Validation</bpmn:outgoing>
      <bpmn:outgoing>SequenceFlow_Notification</bpmn:outgoing>
    </bpmn:inclusiveGateway>
    <bpmn:inclusiveGateway id="Gateway_0wwm3ls">
      <bpmn:incoming>SequenceFlow_2</bpmn:incoming>
      <bpmn:incoming>SequenceFlow_ToValidation</bpmn:incoming>
      <bpmn:outgoing>Flow_004cqad</bpmn:outgoing>
    </bpmn:inclusiveGateway>
    <bpmn:serviceTask id="ServiceTask_AntiFraud" name="Проверка антифрод-системой" camunda:type="external" camunda:topic="anti-fraud-check">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="${processLogger}" event="start" />
        <camunda:inputOutput>
          <camunda:inputParameter name="timeout">${bpmUtil.timeout}</camunda:inputParameter>
          <camunda:inputParameter name="retryTimeout">${bpmUtil.retryTimeout}</camunda:inputParameter>
          <camunda:inputParameter name="retryResponseTimeout">${bpmUtil.retryResponseTimeout}</camunda:inputParameter>
          <camunda:inputParameter name="retryCount">${bpmUtil.retryCount}</camunda:inputParameter>
        </camunda:inputOutput>
        <camunda:executionListener delegateExpression="${processLogger}" event="end" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_004cqad</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_3</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:eventBasedGateway id="EventBasedGateway_1" name="Ожидание документа">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="${processLogger}" event="start" />
        <camunda:executionListener delegateExpression="${processLogger}" event="end" />
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_3</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_DocumentReceived</bpmn:outgoing>
      <bpmn:outgoing>SequenceFlow_Timer</bpmn:outgoing>
    </bpmn:eventBasedGateway>
    <bpmn:sequenceFlow id="SequenceFlow_Timer" sourceRef="EventBasedGateway_1" targetRef="TimerEvent_3Days" />
    <bpmn:sequenceFlow id="SequenceFlow_Timeout" sourceRef="TimerEvent_3Days" targetRef="ServiceTask_Timeout" />
    <bpmn:sequenceFlow id="SequenceFlow_1" sourceRef="StartEvent_1" targetRef="InclusiveGateway_1" />
    <bpmn:sequenceFlow id="SequenceFlow_Validation" sourceRef="InclusiveGateway_1" targetRef="ServiceTask_Validate" />
    <bpmn:sequenceFlow id="SequenceFlow_Notification" sourceRef="InclusiveGateway_1" targetRef="ServiceTask_Notification">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${amount &gt; 100 &amp;&amp; correlationKeyConfirmed == true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="SequenceFlow_ToValidation" sourceRef="ServiceTask_Notification" targetRef="Gateway_0wwm3ls" />
    <bpmn:sequenceFlow id="SequenceFlow_2" sourceRef="ServiceTask_Validate" targetRef="Gateway_0wwm3ls" />
    <bpmn:sequenceFlow id="Flow_004cqad" sourceRef="Gateway_0wwm3ls" targetRef="ServiceTask_AntiFraud" />
    <bpmn:sequenceFlow id="SequenceFlow_3" sourceRef="ServiceTask_AntiFraud" targetRef="EventBasedGateway_1" />
    <bpmn:sequenceFlow id="SequenceFlow_DocumentReceived" sourceRef="EventBasedGateway_1" targetRef="MessageEvent_Document" />
    <bpmn:sequenceFlow id="SequenceFlow_ToDecision" sourceRef="MessageEvent_Document" targetRef="BusinessRuleTask_Decision" />
    <bpmn:sequenceFlow id="SequenceFlow_4" sourceRef="BusinessRuleTask_Decision" targetRef="Gateway_0ek0hhv" />
    <bpmn:sequenceFlow id="SequenceFlow_ToReject" sourceRef="ServiceTask_Timeout" targetRef="ServiceTask_Reject" />
    <bpmn:serviceTask id="ServiceTask_Validate" name="Проверка данных платежа" camunda:expression="${paymentService.validatePayment(execution)}">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="${processLogger}" event="start" />
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_Validation</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_2</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="ServiceTask_Notification" name="Отправить уведомление" camunda:expression="${notificationService.sendLargeAmountNotification(execution)}">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="${processLogger}" event="start" />
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_Notification</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_ToValidation</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="ServiceTask_Timeout" name="Обработать таймаут" camunda:expression="${paymentService.handleTimeout(execution)}">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="${processLogger}" event="start" />
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_Timeout</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_ToReject</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:intermediateCatchEvent id="TimerEvent_3Days" name="3 дня">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="${processLogger}" event="start" />
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_Timer</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_Timeout</bpmn:outgoing>
      <bpmn:timerEventDefinition>
        <bpmn:timeDuration>PT72H</bpmn:timeDuration>
      </bpmn:timerEventDefinition>
    </bpmn:intermediateCatchEvent>
    <bpmn:businessRuleTask id="BusinessRuleTask_Decision" name="Принятие решения по платежу" camunda:resultVariable="paymentDecisionResult" camunda:decisionRef="paymentDecision" camunda:mapDecisionResult="singleEntry">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="${processLogger}" event="start" />
        <camunda:inputOutput>
          <camunda:inputParameter name="amount">${amount}</camunda:inputParameter>
          <camunda:inputParameter name="currency">${currency}</camunda:inputParameter>
          <camunda:inputParameter name="antiFraudResult">${antiFraudResult}</camunda:inputParameter>
        </camunda:inputOutput>
        <camunda:executionListener delegateExpression="${processLogger}" event="end" />
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_ToDecision</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_4</bpmn:outgoing>
    </bpmn:businessRuleTask>
    <bpmn:exclusiveGateway id="Gateway_0ek0hhv" name="Решение">
      <bpmn:extensionElements />
      <bpmn:incoming>SequenceFlow_4</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_Approve</bpmn:outgoing>
      <bpmn:outgoing>SequenceFlow_Reject</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:exclusiveGateway id="Gateway_0wktt5d">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="${processLogger}" event="end" />
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_5</bpmn:incoming>
      <bpmn:incoming>Flow_08enung</bpmn:incoming>
      <bpmn:outgoing>Flow_01y1zag</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:endEvent id="EndEvent_Approved">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="${processLogger}" event="start" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_01y1zag</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:userTask id="UserTask_Approve" name="Проведение платежа" camunda:formRef="paymentForm" camunda:formRefBinding="latest">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="${processLogger}" event="start" />
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_Approve</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_5</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:serviceTask id="ServiceTask_Reject" name="Заблокировать платёж" camunda:expression="${paymentService.rejectPayment(execution)}">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="${processLogger}" event="start" />
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_Reject</bpmn:incoming>
      <bpmn:incoming>SequenceFlow_ToReject</bpmn:incoming>
      <bpmn:outgoing>Flow_08enung</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:sequenceFlow id="SequenceFlow_Approve" sourceRef="Gateway_0ek0hhv" targetRef="UserTask_Approve">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${paymentDecisionResult == 'APPROVE'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="SequenceFlow_Reject" sourceRef="Gateway_0ek0hhv" targetRef="ServiceTask_Reject">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${paymentDecisionResult == "REJECT"}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="SequenceFlow_5" sourceRef="UserTask_Approve" targetRef="Gateway_0wktt5d" />
    <bpmn:sequenceFlow id="Flow_08enung" sourceRef="ServiceTask_Reject" targetRef="Gateway_0wktt5d" />
    <bpmn:sequenceFlow id="Flow_01y1zag" sourceRef="Gateway_0wktt5d" targetRef="EndEvent_Approved" />
    <bpmn:intermediateCatchEvent id="MessageEvent_Document" name="Документ получен">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="${processLogger}" event="start" />
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_DocumentReceived</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_ToDecision</bpmn:outgoing>
      <bpmn:messageEventDefinition messageRef="Message_3a9auqq" />
    </bpmn:intermediateCatchEvent>
  </bpmn:process>
  <bpmn:message id="Message_3a9auqq" name="Документ получен" />
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Collaboration_0ietaej">
      <bpmndi:BPMNShape id="Participant_191iq4g_di" bpmnElement="Participant_191iq4g" isHorizontal="true">
        <dc:Bounds x="160" y="59" width="1350" height="421" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="232" y="202" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="208" y="238" width="85" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="InclusiveGateway_1_di" bpmnElement="InclusiveGateway_1">
        <dc:Bounds x="320" y="195" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="380" y="206" width="56" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_1vefajs" bpmnElement="Gateway_0wwm3ls">
        <dc:Bounds x="525" y="195" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="562" y="-34" width="56" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_AntiFraud_di" bpmnElement="ServiceTask_AntiFraud" bioc:stroke="#205022" bioc:fill="#81D8D0" color:background-color="#81D8D0" color:border-color="#548C87">
        <dc:Bounds x="630" y="180" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EventBasedGateway_1_di" bpmnElement="EventBasedGateway_1">
        <dc:Bounds x="780" y="195" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="783" y="164" width="54" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_Validate_di" bpmnElement="ServiceTask_Validate">
        <dc:Bounds x="400" y="100" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_Notification_di" bpmnElement="ServiceTask_Notification">
        <dc:Bounds x="400" y="260" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_Timeout_di" bpmnElement="ServiceTask_Timeout">
        <dc:Bounds x="966" y="340" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="TimerEvent_3Days_di" bpmnElement="TimerEvent_3Days">
        <dc:Bounds x="880" y="362" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="884" y="398" width="28" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BusinessRuleTask_Decision_di" bpmnElement="BusinessRuleTask_Decision">
        <dc:Bounds x="966" y="180" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_1xzprim" bpmnElement="Gateway_0ek0hhv" isMarkerVisible="true">
        <dc:Bounds x="1115" y="195" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1176" y="210" width="47" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_0eoba6i" bpmnElement="Gateway_0wktt5d" isMarkerVisible="true">
        <dc:Bounds x="1335" y="195" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1194.5" y="123" width="47" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_Approved_di" bpmnElement="EndEvent_Approved">
        <dc:Bounds x="1452" y="202" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1606" y="238" width="49" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="UserTask_Approve_di" bpmnElement="UserTask_Approve">
        <dc:Bounds x="1200" y="100" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_Reject_di" bpmnElement="ServiceTask_Reject">
        <dc:Bounds x="1200" y="260" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="MessageEvent_Document_di" bpmnElement="MessageEvent_Document">
        <dc:Bounds x="880" y="202" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="874" y="238" width="49" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_Timer_di" bpmnElement="SequenceFlow_Timer">
        <di:waypoint x="805" y="245" />
        <di:waypoint x="805" y="380" />
        <di:waypoint x="880" y="380" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_Timeout_di" bpmnElement="SequenceFlow_Timeout">
        <di:waypoint x="916" y="380" />
        <di:waypoint x="966" y="380" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_1_di" bpmnElement="SequenceFlow_1">
        <di:waypoint x="268" y="220" />
        <di:waypoint x="320" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_Validation_di" bpmnElement="SequenceFlow_Validation">
        <di:waypoint x="345" y="195" />
        <di:waypoint x="345" y="140" />
        <di:waypoint x="400" y="140" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_Notification_di" bpmnElement="SequenceFlow_Notification">
        <di:waypoint x="345" y="245" />
        <di:waypoint x="345" y="300" />
        <di:waypoint x="400" y="300" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_ToValidation_di" bpmnElement="SequenceFlow_ToValidation">
        <di:waypoint x="500" y="300" />
        <di:waypoint x="550" y="300" />
        <di:waypoint x="550" y="245" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_2_di" bpmnElement="SequenceFlow_2">
        <di:waypoint x="500" y="140" />
        <di:waypoint x="550" y="140" />
        <di:waypoint x="550" y="195" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_004cqad_di" bpmnElement="Flow_004cqad">
        <di:waypoint x="575" y="220" />
        <di:waypoint x="630" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_3_di" bpmnElement="SequenceFlow_3">
        <di:waypoint x="730" y="220" />
        <di:waypoint x="780" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_DocumentReceived_di" bpmnElement="SequenceFlow_DocumentReceived">
        <di:waypoint x="830" y="220" />
        <di:waypoint x="880" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_ToDecision_di" bpmnElement="SequenceFlow_ToDecision">
        <di:waypoint x="916" y="220" />
        <di:waypoint x="966" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_4_di" bpmnElement="SequenceFlow_4">
        <di:waypoint x="1066" y="220" />
        <di:waypoint x="1115" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_ToReject_di" bpmnElement="SequenceFlow_ToReject">
        <di:waypoint x="1066" y="380" />
        <di:waypoint x="1250" y="380" />
        <di:waypoint x="1250" y="340" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_Approve_di" bpmnElement="SequenceFlow_Approve">
        <di:waypoint x="1140" y="195" />
        <di:waypoint x="1140" y="140" />
        <di:waypoint x="1200" y="140" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_Reject_di" bpmnElement="SequenceFlow_Reject">
        <di:waypoint x="1140" y="245" />
        <di:waypoint x="1140" y="300" />
        <di:waypoint x="1200" y="300" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_5_di" bpmnElement="SequenceFlow_5">
        <di:waypoint x="1300" y="140" />
        <di:waypoint x="1360" y="140" />
        <di:waypoint x="1360" y="195" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_08enung_di" bpmnElement="Flow_08enung">
        <di:waypoint x="1300" y="300" />
        <di:waypoint x="1360" y="300" />
        <di:waypoint x="1360" y="245" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_01y1zag_di" bpmnElement="Flow_01y1zag">
        <di:waypoint x="1385" y="220" />
        <di:waypoint x="1452" y="220" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
